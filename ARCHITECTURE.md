# 项目架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    知识库构建服务                              │
├─────────────────────────────────────────────────────────────┤
│  API层 (FastAPI)                                            │
│  ├── /api/v1/routes.py - 知识库构建API接口                   │
│  └── /main.py - 应用入口和中间件配置                         │
├─────────────────────────────────────────────────────────────┤
│  服务层 (Services)                                          │
│  ├── knowledge_builder.py - 知识库构建核心服务               │
│  ├── database_service.py - 数据库操作服务                    │
│  ├── dify_client.py - Dify API客户端                        │
│  └── external_api_client.py - 外部API客户端                 │
├─────────────────────────────────────────────────────────────┤
│  核心层 (Core)                                              │
│  ├── database.py - 数据库连接管理                           │
│  └── logger.py - 日志管理                                   │
├─────────────────────────────────────────────────────────────┤
│  模型层 (Models)                                            │
│  └── datebase.py - 数据模型定义                             │
├─────────────────────────────────────────────────────────────┤
│  配置层 (Config)                                            │
│  └── config.py - 环境配置管理                               │
└─────────────────────────────────────────────────────────────┘
```

## 数据流

```
外部系统请求 ──→ API接口 ──→ 知识库构建器
                                    ↓
MySQL数据库 ──┐                   数据查询
             ├──→ 数据库服务 ──→ 数据增强 ──→ PDF下载 ──→ Dify知识库
外部API ──────┤                    ↑
             └──→ API服务 ──────┘
PDF文件 ──────┘
```

## 核心组件

### 1. 配置管理 (config.py)
- 使用Pydantic Settings进行环境变量管理
- **敏感信息环境变量化，非敏感信息有默认值**
- 支持多环境配置（开发/测试/生产）
- 自动构建数据库和Redis连接URL
- 配置验证和错误提示机制

### 2. 数据库层 (core/database.py)
- SQLAlchemy ORM集成
- 连接池管理
- 会话管理和事务处理
- 支持上下文管理器

### 3. 数据模型 (model/datebase.py)
- KnowledgeItem模型定义
- 支持多种数据源类型
- 元数据存储
- 处理状态跟踪

### 4. 服务层
#### 数据库服务 (services/database_service.py)
- 自定义SQL查询执行
- CRUD操作封装
- 批量数据处理
- 事务管理

#### Dify客户端 (services/dify_client.py)
- Dify API专用客户端
- 知识库创建和管理
- 文档上传功能
- 异步请求处理

#### 外部API客户端 (services/external_api_client.py)
- 外部API请求封装
- 文件下载功能
- 批量下载支持
- 异步请求处理

### 5. 知识库构建器 (services/knowledge_builder.py)
- 完整的知识库构建管线
- 数据查询和增强
- PDF文件下载
- Dify知识库创建和同步
- 批量数据处理
- 错误处理和重试机制

### 6. API层 (api/routes.py)
- 专注知识库构建的API设计
- 异步和同步任务支持
- 请求参数验证
- 任务状态查询
- 错误处理

## 设计原则

### 1. 解耦设计
- 各层职责清晰分离
- 依赖注入模式
- 接口抽象

### 2. 可扩展性
- 模块化架构
- 插件式服务
- 配置驱动
- 易于添加新数据源

### 3. 精简高效
- 专注核心功能
- 最小化依赖
- 自动化管线
- 性能优化

### 4. 环境管理
- 多环境支持
- 配置外部化
- 安全隔离

## 扩展指南

### 添加新数据源
1. 在`services/external_api_client.py`中添加新的API集成方法
2. 在`knowledge_builder.py`的`_enrich_data_with_api`方法中调用新API
3. 根据需要修改数据模型

### 自定义查询逻辑
1. 修改`knowledge_builder.py`中的`_query_reference_data`方法
2. 添加新的查询条件支持
3. 优化SQL查询性能

### 自定义处理逻辑
1. 修改`_prepare_content`方法自定义内容格式
2. 修改`_prepare_metadata`方法自定义元数据结构
3. 修改`_generate_summary`方法自定义摘要生成

### 部署配置
1. 复制`env.example`为`.env`
2. **只需设置敏感信息环境变量**（IP、用户名、密码、API密钥）
3. 其他配置有合理的默认值，可根据需要覆盖
4. 启动应用服务

**重要**：如果缺少敏感信息环境变量，应用启动时会显示详细错误信息并退出。
